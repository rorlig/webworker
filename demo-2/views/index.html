<!-- working demo of google maps and webworker and socket io --> 
<html>
<head>
	<title>
			Google Maps, Webworker, Node.js and socket io
	</title>
	 <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>

    <!-- load google maps -->
     <script type="text/javascript"
      	src="https://maps.googleapis.com/maps/api/js?sensor=false">
     </script>

     <script src="/socket.io/socket.io.js"></script>


   

     <!-- initialize the google map -->
      <script type="text/javascript">
      	   var map;
      	   var typeIdChangeListener;
      	   var thePanorama;
      	   var streetviewChangeListener;
	      function initialize() {
	        var mapOptions = {
	          center: new google.maps.LatLng(-34.397, 150.644),
	          zoom: 8,
	          mapTypeId: google.maps.MapTypeId.TERRAIN
	        };
	        map = new google.maps.Map(document.getElementById("map-canvas"),
	            mapOptions);

		    /*** streetview ***/
		    thePanorama = map.getStreetView();

	          <!-- google maps events -->
	  		  <!-- zoom -->
	  		    google.maps.event.addListener(map, 'idle', function() {
			  	 // worker.postMessage({'cmd': 'dragend'});

			  	 emitEvents();
 				// socket.emit('map_event', { zoom: map.getZoom(), lat: map.getCenter().lat(), lng: map.getCenter().lng(), type: map.getMapTypeId(), streetview: thePanorama.getVisible() });
			  	 //socket.emit('my other event', { my: 'dragend' });

				    
			  });

	  		//  streetviewChangeListener =  google.maps.event.addListener(thePanorama, 'visible_changed', function() {
	  		//   	console.log('streetview changed');
	  		//   	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		//     emitEvents();
				 // // socket.emit('map_event', { zoom: map.getZoom(), lat: map.getCenter().lat(), lng: map.getCenter().lng(), type: map.getMapTypeId(), streetview: thePanorama.getVisible() });
							  

		   //   });

		     streetviewChangeListener = google.maps.event.addListener(thePanorama, 'zoom_changed', function() {
	  		  	console.log('zoom_changed ');
	  		  	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		    emitEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()});
				 // socket.emit('map_event', { zoom: map.getZoom(), lat: map.getCenter().lat(), lng: map.getCenter().lng(), type: map.getMapTypeId(), streetview: thePanorama.getVisible() });
							  

		     });

		   //   google.maps.event.addListener(thePanorama, 'visible_changed', function() {
	  		//   	console.log('visible_changed ');
	  		//   	// console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		//   	if (!thePanorama.getVisible()){
	  		//   		emitEvents();
	  		//   	} else {
	  		//   		return;
	  		//   	}
	  		    
				 // // socket.emit('map_event', { zoom: map.getZoom(), lat: map.getCenter().lat(), lng: map.getCenter().lng(), type: map.getMapTypeId(), streetview: thePanorama.getVisible() });
							  

		   //   });


	  		  typeIdChangeListener =  google.maps.event.addListener(map, 'maptypeid_changed', function() {
	  		   	console.log('maptypeid_changed');
			  	 // worker.postMessage({'cmd': 'dragend'});
 
			  	 //socket.emit('my other event', { my: 'dragend' });

				    
			  });

			   

			 

	  		    
	  		
	      }

	      function emitEvents(data){
	      	console.log(' streetview visibility value::' + thePanorama.getVisible());
	      	var streetviewVisibility = false;
	      	streetviewVisibility = thePanorama.getVisible();
	      	socket.emit('map_event', { zoom: map.getZoom(), lat: map.getCenter().lat(), lng: map.getCenter().lng(), type: map.getMapTypeId(), streetview: streetviewVisibility, panoramaData: data});
	      }
	      google.maps.event.addDomListener(window, 'load', initialize);

		// <!-- initialize the webworker --> 
	 //    var worker = new Worker('../js/doWork.js');

	 //    <!-- listener for callbacks from worker -->
	 //    worker.addEventListener('message', function(e) {
	 //    	console.log('worker message: ' + e.data);
	 //   	}, false);


		var socket = io.connect('http://107.21.207.8:8090/');
		// var socket = io.connect('http://localhost');
		  socket.on('news', function (data) {
		    console.log(data);
		    socket.emit('my other event', { my: 'data' });
		  });

		   socket.on('map_event', function (data) {
		    console.log("map_event received: " + JSON.stringify(data));
		   map.setCenter(new google.maps.LatLng(data.lat, data.lng));
		   map.setZoom(data.zoom);
		   google.maps.event.removeListener(streetviewChangeListener);
		   //check if showing streetview currently?
		   if (data.panoramaData!=undefined){


			   if (data.streetview) {
			   		if (thePanorama.getVisible()){
			   			return;
			   		}
			   		console.log('show streetview')
			   		console.log('panorama position lat ' + data.panoramaData.position.jb + ' lng: ' + data.panoramaData.position.kb );
			   		thePanorama.setPosition(new google.maps.LatLng(data.panoramaData.position.jb, data.panoramaData.position.kb ));

			   		thePanorama.setZoom(data.panoramaData.zoom);
			   		map.setStreetView(thePanorama);
			   		thePanorama.setVisible(true);
			   } else {
			   		console.log('hide streetview');
			   	    thePanorama.setVisible(false);
			   	    map.setStreetView(thePanorama);
			   }
			} else {
				if (!data.streetview) {
			   		console.log('hide streetview');
			   	    thePanorama.setVisible(false);
			   	    map.setStreetView(thePanorama);
			   	}
			}

		   google.maps.event.removeListener(typeIdChangeListener);

		   map.setMapTypeId(data.type);

	
		  // google.maps.event.addListener(streetviewChangeListener);
		  // google.maps.event.addListener(typeIdChangeListener);

		   streetviewChangeListener =  google.maps.event.addListener(thePanorama, 'zoom_changed', function() {
	  		  	console.log('zoom_changed changed position: ' + thePanorama.getPosition() + " zoom: " + thePanorama.getZoom());
	  		    // emitEvents();
	  		    emitEvents({position: thePanorama.getPosition(), zoom: thePanorama.getZoom()});

				 // socket.emit('map_event', { zoom: map.getZoom(), lat: map.getCenter().lat(), lng: map.getCenter().lng(), type: map.getMapTypeId(), streetview: thePanorama.getVisible() });
							  

		     });

		  typeIdChangeListener =   google.maps.event.addListener(map, 'maptypeid_changed', function() {
	  		   	console.log('maptypeid_changed');
			  	 // worker.postMessage({'cmd': 'dragend'});
			  	 emitEvents();
			  	 // socket.emit('map_event', { zoom: map.getZoom(), lat: map.getCenter().lat(), lng: map.getCenter().lng(), type: map.getMapTypeId(), streetview: thePanorama.getVisible() });

			  	 //socket.emit('my other event', { my: 'dragend' });

				    
			  });
		    // socket.emit('my other event', { my: 'data' });
		  });

		 

		   


	    /* websockets */
	 //   	var connection = new WebSocket('ws://html5rocks.websocket.org/echo', ['soap', 'xmpp']);

	 //   	connection.onopen = function () {
		//   connection.send('Ping'); // Send the message 'Ping' to the server
		// };

		// // Log errors
		// connection.onerror = function (error) {
		//   console.log('WebSocket Error ' + error);
		// };

		// // Log messages from the server
		// connection.onmessage = function (e) {
		//   console.log('Message from the server: ' + e.data);
		// };

		// Sending String



 
 
  		  




	  </script>
	  <script>
		  
	  </script>

</head>
<body>
	<div id="map-canvas">
	</div>
</body>
</html>