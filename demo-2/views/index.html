<!-- working demo of google maps and webworker and socket io --> 
<html>
<head>
	<title>
			Google Maps, Webworker, Node.js and socket io
	</title>
	 <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>

    <!-- load google maps -->
     <script type="text/javascript"
      	src="https://maps.googleapis.com/maps/api/js?sensor=false">
     </script>

     <script src="/socket.io/socket.io.js"></script>


   

     <!-- initialize the google map -->
      <script type="text/javascript">
      	   var map;
      	   var typeIdChangeListener;
      	   var thePanorama;
      	   var streetviewChangeListener;
      	   var streetviewViewListener;
      	   var isStreetViewInitialized;

	      function initialize() {
	        var mapOptions = {
	          center: new google.maps.LatLng(-34.397, 150.644),
	          zoom: 8,
	          mapTypeId: google.maps.MapTypeId.TERRAIN
	        };
	        map = new google.maps.Map(document.getElementById("map-canvas"),
	            mapOptions);

		    /*** streetview ***/
		    thePanorama = map.getStreetView();

	          <!-- google maps events -->
	  		  <!-- zoom -->
	  		    google.maps.event.addListener(map, 'idle', function() {
			  	 emitEvents();
			  });

	  		

	  		  addStreetViewCloseListener();
	  		  addStreetViewListener();
	  		  // addStreetViewPanoListener();

		     // streetviewChangeListener = google.maps.event.addListener(thePanorama, 'visible_changed', function() {
	  		  // 	console.log('visible_changed: ' + thePanorama.getVisible());
	  		  // 	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		  // 	if (thePanorama.getVisible()) {
	  		  //    console.log('calling emitEvents');

	  		  //  	 emitStreetViewEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()});
	  		  //  	}
		     // });

		     // google.maps.event.addListener(thePanorama, 'pano_changed', function() {
	  		  // 	console.log('pano_changed: ' + thePanorama.getVisible());
	  		  // 	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		  // 	if (thePanorama.getVisible()) {
	  		  //    console.log('calling emitEvents');
	  		  //  	 emitStreetViewEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()});
	  		  //  	}
		     // });
			
			// var self = this;

		    // streetviewChangeListener = google.maps.event.addListener(thePanorama, 'zoom_changed', function() {
	  		 //  	console.log('zoom_changed ');
	  		 //  	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		 //    emitStreetViewEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()});
	  		 //    isStreetViewInitialized  = true;
		    //  });


		     //   google.maps.event.addListener(thePanorama, 'position_changed', function() {
	  		  // 	console.log('position_changed position: ' + thePanorama.getPosition() + " zoom: " + thePanorama.getZoom());
	  		  //   emitEvents({position: thePanorama.getPosition(), zoom: thePanorama.getZoom()});
		     // });


		     // streetviewViewListener = google.maps.event.addListener(thePanorama, 'visible_changed', function() {
	  		  // 	console.log('view_changed ');
	  		  // 	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		  // 	console.log(' panorama visibility :' + thePanorama.getVisible());
	  		  // 	// if (!thePanorama.getVisible()) {
	  		  // 		emitEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()});
	  		  // 	// }
	  		  // 		  		  	// if (thePanorama.getVisible()){
	  		  // 	// 	console.log('the panorama is visible');
	  		  // 	// } 
	  		  //   // emitEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()});
		     // });

	  		 typeIdChangeListener =  google.maps.event.addListener(map, 'maptypeid_changed', function() {
	  		   	console.log('maptypeid_changed');
	  		   	emitEvents();
			  });

	      } //end initialize

	      function emitEvents(){
	      	socket.emit('map_event', { zoom: map.getZoom(), lat: map.getCenter().lat(), lng: map.getCenter().lng(), type: map.getMapTypeId()});
	      }

	      function emitStreetViewEvents(data){

	      	console.log('emitStreetViewEvents: ' + JSON.stringify(data));
	        console.log(' streetview visibility value::' + thePanorama.getVisible());
	      	var streetviewVisibility = false;
	      	streetviewVisibility = thePanorama.getVisible();

	      	socket.emit('streetview_event', { zoom: map.getZoom(), lat: map.getCenter().lat(), lng: map.getCenter().lng(), type: map.getMapTypeId(), streetview: streetviewVisibility, panoramaData: data});

	      }

	      google.maps.event.addDomListener(window, 'load', initialize);


		var socket = io.connect('http://107.21.207.8:8090/');
		// var socket = io.connect('http://localhost');
		  
		// map events
		   socket.on('map_event', function (data) {
		    console.log("map_event received: " + JSON.stringify(data));
		  	map.setCenter(new google.maps.LatLng(data.lat, data.lng));
		  	map.setZoom(data.zoom);
		  	//remove the typechangelistener 
		    google.maps.event.removeListener(typeIdChangeListener);


			map.setMapTypeId(data.type);

			//add it back
			typeIdChangeListener =   google.maps.event.addListener(map, 'maptypeid_changed', function() {
	  		   	console.log('maptypeid_changed');
			  	 emitEvents();
			 });

		   });

		  //streetview events
		   socket.on('streetview_event', function(data){
		   	// console.log('received streetview_event: ' + JSON.stringify(data));
		   	// google.maps.event.removeListener(streetviewChangeListener);
		   	removeStreetViewPositionListener();
		    // if (streetviewViewListener!=undefined)
		    // google.maps.event.removeListener(streetviewViewListener);

		    if (data.streetview){
		    	console.log('streetview value is true');
		    	if (data.panoramaData) {

		    		console.log('panoramaData exists');
		    		if (data.panoramaData.position){
		    			console.log('position value exists');

		    			if (!thePanorama.getVisible()){
		    				console.log('panorama is not already showing');
		    				console.log(' position lat: ' + data.panoramaData.position.jb  + " lng: " + data.panoramaData.position.kb);
					    	thePanorama.setPosition(new google.maps.LatLng(data.panoramaData.position.jb, data.panoramaData.position.kb ));
							thePanorama.setZoom(1);
							map.setStreetView(thePanorama);
					   		thePanorama.setVisible(true);
					   	} else {
					   		console.log('panorama is already showing');
					   		thePanorama.setPosition(new google.maps.LatLng(data.panoramaData.position.jb, data.panoramaData.position.kb ));
					   	}
				   	}
		   		}
		    } else {
		    	console.log('streetview value is not true');
		    	thePanorama.setVisible(false);
		    }

		 //   //check if showing streetview currently?
		 //   if (data.panoramaData!=undefined){


			//    if (data.streetview) {
			//    		if (thePanorama.getVisible() ){
			//    			return;
			//    		}
			//    		console.log('show streetview')
			//    		if (data.panoramaData.position!=undefined) {
			//    			console.log('panorama position lat ' + data.panoramaData.position.jb + ' lng: ' + data.panoramaData.position.kb );
			// 	   		thePanorama.setPosition(new google.maps.LatLng(data.panoramaData.position.jb, data.panoramaData.position.kb ));
			// 	   		thePanorama.setZoom(1);
			// 	   		map.setStreetView(thePanorama);
			// 	   		thePanorama.setVisible(true);
			// 	   	}
			//    } else {
			//    		console.log('hide streetview data is false');
			//    	    thePanorama.setVisible(false);
			//    	    // map.setStreetView(null);
			//    }
			// } else {
			// 	if (!data.streetview) {
			//    		console.log('hide streetview since panoramaData is undefined');
			//    	    thePanorama.setVisible(false);
			//    	    // map.setStreetView(null);
			//    	}
			// }

			setTimeout(addStreetViewPositionListener, 1000);


		   // streetviewChangeListener =  google.maps.event.addListener(thePanorama, 'visible_changed', function() {
	  		//   	console.log('visible_changed position: ' + thePanorama.getPosition() + " zoom: " + thePanorama.getZoom());
	  		//     emitStreetViewEvents({position: thePanorama.getPosition(), zoom: thePanorama.getZoom()});
		   //   });

		    // streetviewViewListener = google.maps.event.addListener(thePanorama, 'visible_changed', function() {
	  		 //  	console.log('view_changed ');
	  		 //  	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		 //  	console.log(' panorama visibility :' + thePanorama.getVisible());
	  		 //  	emitStreetViewEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()});
		    //  });


		   // google.maps.event.addListener(thePanorama, 'position_changed', function() {
	  		//   	console.log('position_changed position: ' + thePanorama.getPosition() + " zoom: " + thePanorama.getZoom());
	  		//     emitEvents({position: thePanorama.getPosition(), zoom: thePanorama.getZoom()});
		   //   });


		  // streetviewViewListener = google.maps.event.addListener(thePanorama, 'visible_changed', function() {
	  	// 	  	console.log('view_changed ');
	  	// 	  	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  	// 	  	console.log(' panorama visibility :' + thePanorama.getVisible());
	  	// 	  	// if (!thePanorama.getVisible()) {
	  	// 	  		emitEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()});
	  	// 	  	// }
	  	// 	  		  		  	// if (thePanorama.getVisible()){
	  	// 	  	// 	console.log('the panorama is visible');
	  	// 	  	// } 
	  	// 	    // emitEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()});
		  //    });



		   
		  // socket.emit('my other event', { my: 'data' });

		   });
		
		  function addStreetViewListener() {
		  	streetviewChangeListener = google.maps.event.addListener(thePanorama, 'visible_changed', function() {
	  		  	console.log('visible_changed: ' + thePanorama.getVisible());
	  		  	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		  	if (thePanorama.getVisible()) {
	  		     console.log('calling emitEvents');
	  		     setTimeout(
	  		   	 emitStreetViewEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()}), 5000);
	  		   	}
		     })

		  }

		   function addStreetViewPanoListener() {
		  	streetviewChangeListener = google.maps.event.addListener(thePanorama, 'pano_changed', function() {
	  		  	console.log('pano_changed: ' + thePanorama.getVisible());
	  		  	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		  	if (thePanorama.getVisible()) {
	  		     console.log('calling emitEvents');
	  		     setTimeout(
	  		   	 emitStreetViewEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()}), 5000);
	  		   	}
		     })

		  }

		   function addStreetViewPositionListener() {
		  	streetviewChangeListener = google.maps.event.addListener(thePanorama, 'position_changed', function() {
	  		  	console.log('position_changed: ' + thePanorama.getVisible());
	  		  	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
	  		  	if (thePanorama.getVisible()) {
	  		     console.log('calling emitEvents');
	  		     setTimeout(
	  		   	 emitStreetViewEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()}), 5000);
	  		   	}
		     })

		  }

		  function removeStreetViewPositionListener(){
		  	google.maps.event.removeListener(streetviewChangeListener);
		  }

		  function addStreetViewCloseListener(){
		  	  google.maps.event.addListener(thePanorama, 'closeclick', function() {
	  		  	console.log('closeclick');
	  		  	thePanorama.setVisible(false);
	  		  	// streetviewChangeListener = google.maps.event.addListener(thePanorama, 'visible_changed', function() {
		  		  // 	console.log('visible_changed: ' + thePanorama.getVisible());
		  		  // 	console.log('streetview panorama position: ' + thePanorama.getPosition() + ' zoom: ' + thePanorama.getZoom());
		  		  // 	if (thePanorama.getVisible()) {
		  		  //    console.log('calling emitEvents');
		  		  //  	 emitStreetViewEvents({position: thePanorama.getPosition(),  zoom: thePanorama.getZoom()});
		  		  //  	}
		     	// });
	  		  	emitStreetViewEvents();
	  		  });
		  }
		   

		 

		   


	  



 
 
  		  




	  </script>
	  <script>
		  
	  </script>

</head>
<body>
	<div id="map-canvas">
	</div>
</body>
</html>